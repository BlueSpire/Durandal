(function(t,e){(function(n){"function"==typeof define&&define.amd?define(["jquery"],n):t.sammy=e.Sammy=n(t)})(function(t){var n,i="([^/]+)",r=/:([\w\d]+)/g,o=/\?([^#]*)?$/,a=function(t){return Array.prototype.slice.call(t)},s=function(t){return"[object Function]"===Object.prototype.toString.call(t)},u=function(t){return"[object Array]"===Object.prototype.toString.call(t)},l=function(t){return"[object RegExp]"===Object.prototype.toString.call(t)},c=function(t){return decodeURIComponent((t||"").replace(/\+/g," "))},f=encodeURIComponent,p=function(t){return(t+"").replace(/&(?!\w+;)/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")},h=function(t){return function(){return this.route.apply(this,[t].concat(Array.prototype.slice.call(arguments)))}},d={},g=!(!e.history||!history.pushState),m=[];return n=function(){var e,i,r=a(arguments);return n.apps=n.apps||{},0===r.length||r[0]&&s(r[0])?n.apply(n,["body"].concat(r)):"string"==typeof(i=r.shift())?(e=n.apps[i]||new n.Application,e.element_selector=i,r.length>0&&t.each(r,function(t,n){e.use(n)}),e.element_selector!=i&&delete n.apps[i],n.apps[e.element_selector]=e,e):void 0},n.VERSION="0.7.2",n.addLogger=function(t){m.push(t)},n.log=function(){var e=a(arguments);e.unshift("["+Date()+"]"),t.each(m,function(t,i){i.apply(n,e)})},e.console!==void 0?s(e.console.log.apply)?n.addLogger(function(){e.console.log.apply(e.console,arguments)}):n.addLogger(function(){e.console.log(arguments)}):"undefined"!=typeof console&&n.addLogger(function(){console.log.apply(console,arguments)}),t.extend(n,{makeArray:a,isFunction:s,isArray:u}),n.Object=function(e){return t.extend(this,e||{})},t.extend(n.Object.prototype,{escapeHTML:p,h:p,toHash:function(){var e={};return t.each(this,function(t,n){s(n)||(e[t]=n)}),e},toHTML:function(){var e="";return t.each(this,function(t,n){s(n)||(e+="<strong>"+t+"</strong> "+n+"<br />")}),e},keys:function(t){var e=[];for(var n in this)s(this[n])&&t||e.push(n);return e},has:function(e){return this[e]&&""!==t.trim(""+this[e])},join:function(){var t=a(arguments),e=t.shift();return t.join(e)},log:function(){n.log.apply(n,arguments)},toString:function(e){var n=[];return t.each(this,function(t,i){(!s(i)||e)&&n.push('"'+t+'": '+(""+i))}),"Sammy.Object: {"+n.join(",")+"}"}}),n.DefaultLocationProxy=function(t,e){this.app=t,this.is_native=!1,this.has_history=g,this._startPolling(e)},n.DefaultLocationProxy.fullPath=function(t){var e=(""+t).match(/^[^#]*(#.+)$/),n=e?e[1]:"";return[t.pathname,t.search,n].join("")},t.extend(n.DefaultLocationProxy.prototype,{bind:function(){var i=this,r=this.app,o=n.DefaultLocationProxy;t(e).bind("hashchange."+this.app.eventNamespace(),function(t,n){i.is_native!==!1||n||(i.is_native=!0,e.clearInterval(o._interval),o._interval=null),r.trigger("location-changed")}),g&&!r.disable_push_state&&(t(e).bind("popstate."+this.app.eventNamespace(),function(){r.trigger("location-changed")}),t("a").live("click.history-"+this.app.eventNamespace(),function(t){if(!(t.isDefaultPrevented()||t.metaKey||t.ctrlKey)){var n=o.fullPath(this);return this.hostname==e.location.hostname&&r.lookupRoute("get",n)&&"_blank"!==this.target?(t.preventDefault(),i.setLocation(n),!1):void 0}})),o._bindings||(o._bindings=0),o._bindings++},unbind:function(){t(e).unbind("hashchange."+this.app.eventNamespace()),t(e).unbind("popstate."+this.app.eventNamespace()),t("a").die("click.history-"+this.app.eventNamespace()),n.DefaultLocationProxy._bindings--,0>=n.DefaultLocationProxy._bindings&&(e.clearInterval(n.DefaultLocationProxy._interval),n.DefaultLocationProxy._interval=null)},getLocation:function(){return n.DefaultLocationProxy.fullPath(e.location)},setLocation:function(t){if(/^([^#\/]|$)/.test(t)&&(t=g&&!this.app.disable_push_state?"/"+t:"#!/"+t),t!=this.getLocation()){if(!g||this.app.disable_push_state||!/^\//.test(t))return e.location=t;history.pushState({path:t},e.title,t),this.app.trigger("location-changed")}},_startPolling:function(i){var r=this;if(!n.DefaultLocationProxy._interval){i||(i=10);var o=function(){var i=r.getLocation();(n.DefaultLocationProxy._last_location===void 0||i!=n.DefaultLocationProxy._last_location)&&e.setTimeout(function(){t(e).trigger("hashchange",[!0])},0),n.DefaultLocationProxy._last_location=i};o(),n.DefaultLocationProxy._interval=e.setInterval(o,i)}}}),n.Application=function(t){var e=this;this.routes={},this.listeners=new n.Object({}),this.arounds=[],this.befores=[],this.namespace=(new Date).getTime()+"-"+parseInt(1e3*Math.random(),10),this.context_prototype=function(){n.EventContext.apply(this,arguments)},this.context_prototype.prototype=new n.EventContext,s(t)&&t.apply(this,[this]),this._location_proxy||this.setLocationProxy(new n.DefaultLocationProxy(this,this.run_interval_every)),this.debug&&this.bindToAllEvents(function(t,n){e.log(""+e,t.cleaned_type,n||{})})},n.Application.prototype=t.extend({},n.Object.prototype,{ROUTE_VERBS:["get","post","put","delete"],APP_EVENTS:["run","unload","lookup-route","run-route","route-found","event-context-before","event-context-after","changed","error","check-form-submission","redirect","location-changed"],_last_route:null,_location_proxy:null,_running:!1,element_selector:"body",debug:!1,raise_errors:!1,run_interval_every:50,disable_push_state:!1,template_engine:null,toString:function(){return"Sammy.Application:"+this.element_selector},$element:function(e){return e?t(this.element_selector).find(e):t(this.element_selector)},use:function(){var t=a(arguments),e=t.shift(),i=e||"";try{t.unshift(this),"string"==typeof e&&(i="Sammy."+e,e=n[e]),e.apply(this,t)}catch(r){e===void 0?this.error("Plugin Error: called use() but plugin ("+(""+i)+") is not defined",r):s(e)?this.error("Plugin Error",r):this.error("Plugin Error: called use() but '"+(""+i)+"' is not a function",r)}return this},setLocationProxy:function(t){var e=this._location_proxy;this._location_proxy=t,this.isRunning()&&(e&&e.unbind(),this._location_proxy.bind())},log:function(){n.log.apply(n,Array.prototype.concat.apply([this.element_selector],arguments))},route:function(e,n){var o,a,u=this,l=[],c=Array.prototype.slice.call(arguments,2);if(0===c.length&&s(n)&&(n=e,c=[n],e="any"),e=e.toLowerCase(),n.constructor==String){for(r.lastIndex=0;null!==(a=r.exec(n));)l.push(a[1]);n=RegExp(n.replace(r,i)+"$")}return t.each(c,function(t,e){"string"==typeof e&&(c[t]=u[e])}),o=function(t){var e={verb:t,path:n,callback:c,param_names:l};u.routes[t]=u.routes[t]||[],u.routes[t].push(e)},"any"===e?t.each(this.ROUTE_VERBS,function(t,e){o(e)}):o(e),this},get:h("get"),post:h("post"),put:h("put"),del:h("delete"),any:h("any"),mapRoutes:function(e){var n=this;return t.each(e,function(t,e){n.route.apply(n,e)}),this},eventNamespace:function(){return["sammy-app",this.namespace].join("-")},bind:function(t,e,n){var i=this;n===void 0&&(n=e);var r=function(){var t,e,r;t=arguments[0],r=arguments[1],r&&r.context?(e=r.context,delete r.context):e=new i.context_prototype(i,"bind",t.type,r,t.target),t.cleaned_type=t.type.replace(i.eventNamespace(),""),n.apply(e,[t,r])};return this.listeners[t]||(this.listeners[t]=[]),this.listeners[t].push(r),this.isRunning()&&this._listen(t,r),this},trigger:function(t,e){return this.$element().trigger([t,this.eventNamespace()].join("."),[e]),this},refresh:function(){return this.last_location=null,this.trigger("location-changed"),this},before:function(t,e){return s(t)&&(e=t,t={}),this.befores.push([t,e]),this},after:function(t){return this.bind("event-context-after",t)},around:function(t){return this.arounds.push(t),this},onComplete:function(t){return this._onComplete=t,this},isRunning:function(){return this._running},helpers:function(e){return t.extend(this.context_prototype.prototype,e),this},helper:function(t,e){return this.context_prototype.prototype[t]=e,this},run:function(n){if(this.isRunning())return!1;var i=this;return t.each(this.listeners.toHash(),function(e,n){t.each(n,function(t,n){i._listen(e,n)})}),this.trigger("run",{start_url:n}),this._running=!0,this.last_location=null,/\#(.+)/.test(this.getLocation())||void 0===n||this.setLocation(n),this._checkLocation(),this._location_proxy.bind(),this.bind("location-changed",function(){i._checkLocation()}),this.bind("submit",function(e){var n=i._checkFormSubmission(t(e.target).closest("form"));return n===!1?e.preventDefault():!1}),t(e).bind("unload",function(){i.unload()}),this.trigger("changed")},unload:function(){if(!this.isRunning())return!1;var e=this;return this.trigger("unload"),this._location_proxy.unbind(),this.$element().unbind("submit").removeClass(e.eventNamespace()),t.each(this.listeners.toHash(),function(n,i){t.each(i,function(t,i){e._unlisten(n,i)})}),this._running=!1,this},destroy:function(){return this.unload(),delete n.apps[this.element_selector],this},bindToAllEvents:function(e){var n=this;return t.each(this.APP_EVENTS,function(t,i){n.bind(i,e)}),t.each(this.listeners.keys(!0),function(i,r){-1==t.inArray(r,n.APP_EVENTS)&&n.bind(r,e)}),this},routablePath:function(t){return t.replace(o,"")},lookupRoute:function(t,e){var n,i,r=this,o=!1,a=0;if(this.routes[t]!==void 0)for(n=this.routes[t].length;n>a;a++)if(i=this.routes[t][a],r.routablePath(e).match(i.path)){o=i;break}return o},runRoute:function(e,n,i,r){var o,a,s,u,l,f,p,h,d=this,g=this.lookupRoute(e,n);if(this.debug&&this.log("runRoute",[e,n].join(" ")),this.trigger("run-route",{verb:e,path:n,params:i}),i===void 0&&(i={}),t.extend(i,this._parseQueryString(n)),g){this.trigger("route-found",{route:g}),null!==(p=g.path.exec(this.routablePath(n)))&&(p.shift(),t.each(p,function(t,e){g.param_names[t]?i[g.param_names[t]]=c(e):(i.splat||(i.splat=[]),i.splat.push(c(e)))})),o=new this.context_prototype(this,e,n,i,r),s=this.arounds.slice(0),u=this.befores.slice(0),f=[o],i.splat&&(f=f.concat(i.splat)),a=function(){for(var t,e,n;u.length>0;)if(l=u.shift(),d.contextMatchesOptions(o,l[0])&&(t=l[1].apply(o,[o]),t===!1))return!1;return d.last_route=g,o.trigger("event-context-before",{context:o}),"function"==typeof g.callback&&(g.callback=[g.callback]),g.callback&&g.callback.length&&(e=-1,n=function(){e++,g.callback[e]?t=g.callback[e].apply(o,f):d._onComplete&&d._onComplete(o)},f.push(n),n()),o.trigger("event-context-after",{context:o}),t},t.each(s.reverse(),function(t,e){var n=a;a=function(){return e.apply(o,[n])}});try{h=a()}catch(m){this.error(["500 Error",e,n].join(" "),m)}return h}return this.notFound(e,n)},contextMatchesOptions:function(e,n,i){var r=n;if(("string"==typeof r||l(r))&&(r={path:r}),i===void 0&&(i=!0),t.isEmptyObject(r))return!0;if(u(r.path)){var o,a,s,c;for(o=[],a=0,c=r.path.length;c>a;a+=1)s=t.extend({},r,{path:r.path[a]}),o.push(this.contextMatchesOptions(e,s));var f=t.inArray(!0,o)>-1?!0:!1;return i?f:!f}if(r.only)return this.contextMatchesOptions(e,r.only,!0);if(r.except)return this.contextMatchesOptions(e,r.except,!1);var p=!0,h=!0;return r.path&&(l(r.path)||(r.path=RegExp(""+r.path+"$")),p=r.path.test(e.path)),r.verb&&(h="string"==typeof r.verb?r.verb===e.verb:r.verb.indexOf(e.verb)>-1),i?h&&p:!(h&&p)},getLocation:function(){return this._location_proxy.getLocation()},setLocation:function(t){return this._location_proxy.setLocation(t)},swap:function(t,e){var n=this.$element().html(t);return s(e)&&e(t),n},templateCache:function(t,e){return e!==void 0?d[t]=e:d[t]},clearTemplateCache:function(){return d={}},notFound:function(t,e){var n=this.error(["404 Not Found",t,e].join(" "));return"get"===t?n:!0},error:function(t,e){if(e||(e=Error()),e.message=[t,e.message].join(" "),this.trigger("error",{message:e.message,error:e}),this.raise_errors)throw e;this.log(e.message,e)},_checkLocation:function(){var t,e;return t=this.getLocation(),this.last_location&&"get"==this.last_location[0]&&this.last_location[1]==t||(this.last_location=["get",t],e=this.runRoute("get",t)),e},_getFormVerb:function(e){var n,i,r=t(e);return i=r.find('input[name="_method"]'),i.length>0&&(n=i.val()),n||(n=r[0].getAttribute("method")),n&&""!==n||(n="get"),t.trim((""+n).toLowerCase())},_checkFormSubmission:function(e){var n,i,r,o,a;return this.trigger("check-form-submission",{form:e}),n=t(e),i=n.attr("action")||"",r=this._getFormVerb(n),this.debug&&this.log("_checkFormSubmission",n,i,r),"get"===r?(o=this._serializeFormParams(n),""!==o&&(i+="?"+o),this.setLocation(i),a=!1):(o=t.extend({},this._parseFormParams(n)),a=this.runRoute(r,i,o,e.get(0))),a===void 0?!1:a},_serializeFormParams:function(t){var e,n="",i=t.serializeArray();if(i.length>0)for(n=this._encodeFormPair(i[0].name,i[0].value),e=1;i.length>e;e++)n=n+"&"+this._encodeFormPair(i[e].name,i[e].value);return n},_encodeFormPair:function(t,e){return f(t)+"="+f(e)},_parseFormParams:function(t){var e,n={},i=t.serializeArray();for(e=0;i.length>e;e++)n=this._parseParamPair(n,i[e].name,i[e].value);return n},_parseQueryString:function(t){var e,n,i,r,a={};if(e=t.match(o),e&&e[1])for(n=e[1].split("&"),r=0;n.length>r;r++)i=n[r].split("="),a=this._parseParamPair(a,c(i[0]),c(i[1]||""));return a},_parseParamPair:function(t,e,n){return t[e]!==void 0?u(t[e])?t[e].push(n):t[e]=[t[e],n]:t[e]=n,t},_listen:function(t,e){return this.$element().bind([t,this.eventNamespace()].join("."),e)},_unlisten:function(t,e){return this.$element().unbind([t,this.eventNamespace()].join("."),e)}}),n.RenderContext=function(t){this.event_context=t,this.callbacks=[],this.previous_content=null,this.content=null,this.next_engine=!1,this.waiting=!1},n.RenderContext.prototype=t.extend({},n.Object.prototype,{then:function(t){if(!s(t)){if(!("string"==typeof t&&t in this.event_context))return this;var n=this.event_context[t];t=function(t){return n.apply(this.event_context,[t])}}var i=this;return this.waiting?this.callbacks.push(t):(this.wait(),e.setTimeout(function(){var e=t.apply(i,[i.content,i.previous_content]);e!==!1&&i.next(e)},0)),this},wait:function(){this.waiting=!0},next:function(t){this.waiting=!1,t!==void 0&&(this.previous_content=this.content,this.content=t),this.callbacks.length>0&&this.then(this.callbacks.shift())},load:function(e,n,i){var r=this;return this.then(function(){var o,a,u;return s(n)?(i=n,n={}):n=t.extend({},n),i&&this.then(i),"string"==typeof e?(u=e.match(/\.json$/)||n.json,o=u?n.cache===!0:n.cache!==!1,r.next_engine=r.event_context.engineFor(e),delete n.cache,delete n.json,n.engine&&(r.next_engine=n.engine,delete n.engine),o&&(a=this.event_context.app.templateCache(e))?a:(this.wait(),t.ajax(t.extend({url:e,data:{},dataType:u?"json":"text",type:"get",success:function(t){o&&r.event_context.app.templateCache(e,t),r.next(t)}},n)),!1)):e.nodeType?e.innerHTML:e.selector?(r.next_engine=e.attr("data-engine"),n.clone===!1?""+e.remove()[0].innerHTML:""+e[0].innerHTML):void 0})},loadPartials:function(t){var e;if(t){this.partials=this.partials||{};for(e in t)(function(e,n){e.load(t[n]).then(function(t){this.partials[n]=t})})(this,e)}return this},render:function(t,e,n,i){return s(t)&&!e?this.then(t):(s(e)?(i=n,n=e,e=null):n&&!s(n)&&(i=n,n=null),this.loadPartials(i).load(t).interpolate(e,t).then(n))},partial:function(t,e,n,i){return s(n)?this.render(t,e,i).swap(n):s(e)?this.render(t,{},n).swap(e):this.render(t,e,n).swap()},send:function(){var t=this,e=a(arguments),n=e.shift();return u(e[0])&&(e=e[0]),this.then(function(){return e.push(function(e){t.next(e)}),t.wait(),n.apply(n,e),!1})},collect:function(e,n,i){var r=this,o=function(){s(e)&&(n=e,e=this.content);var i=[],o=!1;return t.each(e,function(t,e){var a=n.apply(r,[t,e]);return a.jquery&&1==a.length&&(a=a[0],o=!0),i.push(a),a}),o?i:i.join("")};return i?o():this.then(o)},renderEach:function(e,n,i,r){return u(n)&&(r=i,i=n,n=null),this.load(e).then(function(o){var a=this;return i||(i=u(this.previous_content)?this.previous_content:[]),r?(t.each(i,function(t,i){var s={},u=this.next_engine||e;n?s[n]=i:s=i,r(i,a.event_context.interpolate(o,s,u))}),void 0):this.collect(i,function(t,i){var r={},a=this.next_engine||e;return n?r[n]=i:r=i,this.event_context.interpolate(o,r,a)},!0)})},interpolate:function(t,e,n){var i=this;return this.then(function(r,o){!t&&o&&(t=o),this.next_engine&&(e=this.next_engine,this.next_engine=!1);var a=i.event_context.interpolate(r,t,e,this.partials);return n?o+a:a})},swap:function(t){return this.then(function(e){return this.event_context.swap(e,t),e}).trigger("changed",{})},appendTo:function(e){return this.then(function(n){t(e).append(n)}).trigger("changed",{})},prependTo:function(e){return this.then(function(n){t(e).prepend(n)}).trigger("changed",{})},replace:function(e){return this.then(function(n){t(e).html(n)}).trigger("changed",{})},trigger:function(t,e){return this.then(function(n){return e===void 0&&(e={content:n}),this.event_context.trigger(t,e),n})}}),n.EventContext=function(t,e,i,r,o){this.app=t,this.verb=e,this.path=i,this.params=new n.Object(r),this.target=o},n.EventContext.prototype=t.extend({},n.Object.prototype,{$element:function(){return this.app.$element(a(arguments).shift())},engineFor:function(t){var e,n=this;return s(t)?t:(t=""+(t||n.app.template_engine),(e=t.match(/\.([^\.\?\#]+)$/))&&(t=e[1]),t&&s(n[t])?n[t]:n.app.template_engine?this.engineFor(n.app.template_engine):function(t){return t})},interpolate:function(t,e,n,i){return this.engineFor(n).apply(this,[t,e,i])},render:function(t,e,i,r){return new n.RenderContext(this).render(t,e,i,r)},renderEach:function(t,e,i,r){return new n.RenderContext(this).renderEach(t,e,i,r)},load:function(t,e,i){return new n.RenderContext(this).load(t,e,i)},loadPartials:function(t){return new n.RenderContext(this).loadPartials(t)},partial:function(t,e,i,r){return new n.RenderContext(this).partial(t,e,i,r)},send:function(){var t=new n.RenderContext(this);return t.send.apply(t,arguments)},redirect:function(){var e,n=a(arguments),i=this.app.getLocation(),r=n.length;if(r>1){for(var o=0,s=[],u=[],l={},c=!1;r>o;o++)"string"==typeof n[o]?s.push(n[o]):(t.extend(l,n[o]),c=!0);if(e=s.join("/"),c){for(var f in l)u.push(this.app._encodeFormPair(f,l[f]));e+="?"+u.join("&")}}else e=n[0];this.trigger("redirect",{to:e}),this.app.last_location=[this.verb,this.path],this.app.setLocation(e),RegExp(e).test(i)&&this.app.trigger("location-changed")},trigger:function(t,e){return e===void 0&&(e={}),e.context||(e.context=this),this.app.trigger(t,e)},eventNamespace:function(){return this.app.eventNamespace()},swap:function(t,e){return this.app.swap(t,e)},notFound:function(){return this.app.notFound(this.verb,this.path)},json:function(e){return t.parseJSON(e)},toString:function(){return"Sammy.EventContext: "+[this.verb,this.path,this.params].join(" ")}}),n})})(jQuery,window);